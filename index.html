<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>30-DAYS BYE-BYE M·ª† B·ª§NG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    /* Pastel pink-orange theme */
    --p1:#ff9eb3; /* h·ªìng nh·∫°t */
    --p2:#ffb88a; /* cam nh·∫°t */
    --p3:#ffe0a3; /* v√†ng kem */
    --pink:#ff8fab; --peach:#ffb3c1; --apricot:#ffd6a5;
    --mint:#b7e4c7; --sky:#cde5ff;

    --bg:#fff7fb; --bg-grad:#fff0f6;
    --text:#2a2a2a; --muted:#6b7280;
    --card:#ffffff; --border:#f1dfe6;
    --chip:#ffeaf1; --chip-border:#ffd6e3;

    --success:#22c55e; --warn:#f59e0b;

    --col-huong:#ff8fab; /* H∆∞∆°ng */
    --col-thuy:#a5b4fc; /* Th√πy  */
    --col-lien:#b7e4c7; /* Li√™n  */
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,var(--bg-grad) 0%, #fff 40%, #fff 100%) fixed;
  }
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .hero{
    border:1px solid var(--border);border-radius:18px;padding:20px;
    background:linear-gradient(135deg, #fff0f6 0%, #fff 45%, #fff5f0 100%);
    box-shadow:0 12px 32px rgba(255, 179, 193,.25);
  }
  .hero h1{margin:0;font-size:28px;letter-spacing:.2px}
  .subtitle{margin-top:6px;color:var(--muted)}
  .chips{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--chip-border);padding:6px 10px;border-radius:999px;font-size:12px}

  .grid{display:grid;gap:16px;margin-top:16px}
  @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}

  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;
    box-shadow:0 10px 24px rgba(255,152,175,.15);
  }
  .card h2{margin:0 0 12px;font-size:18px}

  .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.03)}
  .btn-pink{background:linear-gradient(90deg,var(--p1),var(--p2));border-color:#ffc3d1;color:#4a1d2a}
  .btn-lt{background:#fff;border-color:#f2c3c9}

  .row{display:flex;align-items:center;gap:12px;background:#fff;border:1px solid var(--border);padding:10px;border-radius:12px}
  .lb{display:flex;flex-direction:column;gap:10px}
  .medal{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-weight:800;color:#7a4b00;background:linear-gradient(180deg,#ffd089,#ffbd63)}
  .medal.silver{background:linear-gradient(180deg,#e8eef7,#cfd8e6);color:#3c4a64}
  .medal.bronze{background:linear-gradient(180deg,#ffd9b3,#f1bb86);color:#6b3c09}

  .name{min-width:84px;display:flex;align-items:center;gap:8px}
  .avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:800;color:#ffffff}
  .a-huong{background:var(--col-huong)} .a-thuy{background:var(--col-thuy)} .a-lien{background:var(--col-lien); color:#175b3a}

  .bar{width:100%;height:10px;background:#ffe9ef;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%}
  .cnt{margin-left:auto;font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}

  .legend{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-top:8px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:center;padding:8px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:#fff}
  tbody tr{background:#fff}
  th:first-child,td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px;text-align:left}
  th:last-child,td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
  .daycell{user-select:none;position:relative}
  .daycell.enabled{cursor:pointer;transition:transform .05s}
  .daycell.enabled:active{transform:scale(.98)}
  .daycell.done{background:linear-gradient(180deg,rgba(34,197,94,.12),rgba(34,197,94,.04)); box-shadow:inset 0 0 0 2px rgba(34,197,94,.2)}
  .daycell.lock{opacity:.35}
  .editpin{position:absolute;right:6px;bottom:4px;font-size:12px;color:#9aa1b1}
  .editpin:hover{color:#555}

  .progressCol{display:flex;flex-direction:column;gap:10px}

  /* Toast & Modal */
  .toast{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.15);display:none}
  .toast.show{display:block;animation:fade .2s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:16px}
  .modal{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:520px;width:100%;padding:16px}
  .modal h3{margin:0 0 10px}
  .modal .row{background:#fff}
  input[type="text"], input[type="number"], textarea{
    width:100%;background:#fff;border:1px solid #f1dfe6;border-radius:10px;padding:10px;color:var(--text)
  }

  /* Confetti canvas */
  canvas#confetti{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<audio id="ding" preload="auto">
  <!-- very short beep-like ding (base64) -->
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA... (shortened) ..." type="audio/mp3">
</audio>

<div class="wrap">
  <div class="hero">
    <h1>30-DAYS BYE-BYE M·ª† B·ª§NG</h1>
    <div class="subtitle">M·ªói ng∆∞·ªùi c√≥ <b>ng√†y b·∫Øt ƒë·∫ßu ri√™ng</b>. C√≥ th·ªÉ tick c√°c ng√†y <b>ƒë·∫øn h√¥m nay</b>, kh√¥ng tick t∆∞∆°ng lai. Th√™m c√¢n n·∫∑ng/·∫£nh/ghi ch√∫ cho t·ª´ng ng√†y.</div>
    <div class="chips">
      <span class="chip">‚úÖ Backfill qu√° kh·ª©</span>
      <span class="chip">üîî Ding khi check-in</span>
      <span class="chip">üèÖ M·ªëc 7/15/30 + Quote</span>
    </div>
  </div>

  <!-- B·∫ÆT ƒê·∫¶U -->
  <div class="card" style="margin-top:14px">
    <h2>üóìÔ∏è Ng√†y b·∫Øt ƒë·∫ßu th·ª≠ th√°ch (m·ªói ng∆∞·ªùi)</h2>
    <div class="settings" id="startSettings" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
  </div>

  <div class="grid">
    <!-- TR√ÅI -->
    <div class="card">
      <h2>üèÜ Leaderboard (t·ªïng ‚úÖ & streak)</h2>
      <div id="leaderboard" class="lb"></div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-pink"  onclick="checkin('Huong')">‚úÖ Check-in: H∆∞∆°ng</button>
        <button class="btn btn-pink"  onclick="checkin('Thuy')" style="background:linear-gradient(90deg,#a5b4fc,#c7d2fe)">‚úÖ Check-in: Th√πy</button>
        <button class="btn btn-pink"  onclick="checkin('Lien')" style="background:linear-gradient(90deg,#b7e4c7,#d8f3dc)">‚úÖ Check-in: Li√™n</button>
        <span class="muted">N√∫t check-in ƒë√°nh v√†o ‚Äúh√¥m nay‚Äù; qu√° kh·ª© b·∫•m tr·ª±c ti·∫øp √¥.</span>
      </div>

      <h2 style="margin-top:18px">üìÖ B·∫£ng chi ti·∫øt 30 ng√†y (l·ªô tr√¨nh c√° nh√¢n)</h2>
      <div class="legend">
        <span><i class="dot" style="background:var(--col-huong)"></i>H∆∞∆°ng</span>
        <span><i class="dot" style="background:var(--col-thuy)"></i>Th√πy</span>
        <span><i class="dot" style="background:var(--col-lien)"></i>Li√™n</span>
      </div>
      <div style="overflow-x:auto;margin-top:8px">
        <table id="daysTable"></table>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-lt" onclick="exportData()">‚¨áÔ∏è Xu·∫•t JSON</button>
        <label>
          <input type="file" accept="application/json" style="display:none" id="importFile"/>
          <button class="btn btn-lt" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Nh·∫≠p JSON</button>
        </label>
        <button class="btn btn-lt" onclick="resetAll()">üîÅ Reset to√†n b·ªô</button>
        <span class="muted">D·ªØ li·ªáu l∆∞u localStorage (m·ªói tr√¨nh duy·ªát ri√™ng).</span>
      </div>
    </div>

    <!-- PH·∫¢I -->
    <div class="card">
      <h2>üìä Bi·ªÉu ƒë·ªì & üìà Ti·∫øn ƒë·ªô c√° nh√¢n</h2>
      <canvas id="barChart" height="220" style="background:#fff;border-radius:12px;border:1px solid var(--border)"></canvas>
      <div id="progressWrap" class="progressCol" style="margin-top:16px"></div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- MODAL NH·∫¨T K√ù -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle">Nh·∫≠t k√Ω</h3>
    <div style="display:grid;gap:10px">
      <div>
        <label>C√¢n n·∫∑ng (kg)</label>
        <input id="inpWeight" type="number" min="0" step="0.1" placeholder="V√≠ d·ª•: 55.4"/>
      </div>
      <div>
        <label>Ghi ch√∫ / C·∫£m nh·∫≠n</label>
        <textarea id="inpNote" rows="3" placeholder="H√¥m nay plank 2 ph√∫t, u·ªëng 2L n∆∞·ªõc..."></textarea>
      </div>
      <div>
        <label>·∫¢nh (URL) ho·∫∑c t·∫£i ·∫£nh</label>
        <input id="inpImgUrl" type="text" placeholder="https://..."/>
        <div class="row" style="margin-top:6px">
          <input id="inpImgFile" type="file" accept="image/*"/>
          <span class="muted">N·∫øu ch·ªçn ·∫£nh, m√¨nh s·∫Ω l∆∞u b·∫£n thu nh·ªè v√†o tr√¨nh duy·ªát.</span>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btn-lt" onclick="closeModal()">Hu·ª∑</button>
        <button class="btn btn-pink" onclick="saveJournal()">L∆∞u nh·∫≠t k√Ω</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================== STATE ================== */
const KEY = "30days-bellyfat-challenge-v7";
const members = [
  { id:"Huong", name:"H∆∞∆°ng", color:"var(--col-huong)", avatarClass:"a-huong" },
  { id:"Thuy",  name:"Th√πy",  color:"var(--col-thuy)",  avatarClass:"a-thuy"  },
  { id:"Lien",  name:"Li√™n",  color:"var(--col-lien)",  avatarClass:"a-lien"  }
];
const DAYS = 30;
/* state:
  days[dayIndex][memberId]=boolean
  meta.startDate[memberId]=YYYY-MM-DD
  journal[dayIndex][memberId]={ w:number|null, note:string, imgUrl:string|null, imgData:string|null }
  meta.milestoneShown[memberId]={7:true,15:true,30:true}  // ƒë·ªÉ kh√¥ng hi·ªán l·∫∑p
*/
function defaultState(){
  return {
    days: Array.from({length:DAYS},()=>({Huong:false,Thuy:false,Lien:false})),
    journal: Array.from({length:DAYS},()=>({Huong:null,Thuy:null,Lien:null})),
    meta:{
      startDate:{Huong:null,Thuy:null,Lien:null},
      milestoneShown:{Huong:{},Thuy:{},Lien:{}}
    }
  };
}
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw){ const s=defaultState(); save(s); return s; }
  try{
    const s=JSON.parse(raw);
    if(!s.meta) s.meta={startDate:{Huong:null,Thuy:null,Lien:null}, milestoneShown:{Huong:{},Thuy:{},Lien:{}}};
    if(!s.journal) s.journal = Array.from({length:DAYS},()=>({Huong:null,Thuy:null,Lien:null}));
    return s;
  }catch(_){ const s=defaultState(); save(s); return s; }
}
function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
let state = load();

/* ================== DATE HELPERS ================== */
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function parseYMD(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return startOfDay(new Date(y,m-1,d)); }
function daysDiff(a,b){ return Math.floor((startOfDay(a)-startOfDay(b))/86400000); }
function today(){ return startOfDay(new Date()); }
/* index h√¥m nay theo startDate t·ª´ng ng∆∞·ªùi; null: ch∆∞a set; <0: ch∆∞a b·∫Øt ƒë·∫ßu; >=30: qu√° h·∫°n */
function todayIndexFor(id){
  const sdStr = state.meta.startDate[id];
  if(!sdStr) return null;
  return daysDiff(today(), parseYMD(sdStr));
}
/* cho click: <= h√¥m nay (backfill), kh√¥ng > h√¥m nay; n·∫øu ƒë√£ qua 30d, v·∫´n s·ª≠a qu√° kh·ª© */
function isCellEnabled(day,id){
  const idx=todayIndexFor(id);
  if(idx===null) return false;
  if(idx<0) return false;
  if(idx>=DAYS) return day<=DAYS-1;
  return day<=idx;
}

/* ================== AGG ================== */
function totalOf(id){ return state.days.reduce((a,d)=>a+(d[id]?1:0),0); }
function streakOf(id){
  const idx=todayIndexFor(id);
  if(idx===null) return 0;
  const last=Math.min(Math.max(idx,-1),DAYS-1);
  if(last<0) return 0;
  let s=0;
  for(let i=last;i>=0;i--){
    if(state.days[i][id]) s++; else break;
  }
  return s;
}

/* ================== UI ELS ================== */
const lbEl = document.getElementById('leaderboard');
const tableEl = document.getElementById('daysTable');
const prWrap = document.getElementById('progressWrap');
const toastEl = document.getElementById('toast');
const dingEl  = document.getElementById('ding');

/* ================== START SETTINGS ================== */
const startSettings = document.getElementById('startSettings');
function buildStartSettings(){
  startSettings.innerHTML="";
  members.forEach(m=>{
    const box=document.createElement('div');
    box.className="row";
    box.style.background="#fff";
    box.innerHTML = `
      <div class="name" style="min-width:auto">
        <span class="avatar ${m.avatarClass}">${m.name[0]}</span>
        <b style="color:${m.color}">${m.name}</b>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="date" id="start_${m.id}" value="${state.meta.startDate[m.id] ?? ""}"/>
        <button class="btn btn-lt" onclick="saveStart('${m.id}')">L∆∞u</button>
        <span class="muted" id="hint_${m.id}"></span>
      </div>
    `;
    startSettings.appendChild(box);
    updateStartHints(m.id);
  });
}
function saveStart(id){
  const inp=document.getElementById('start_'+id);
  if(!inp.value){ toast("Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu cho "+id); return; }
  state.meta.startDate[id]=inp.value; save(state); refresh();
}
function updateStartHints(id){
  const hint=document.getElementById('hint_'+id);
  const idx=todayIndexFor(id);
  if(hint){
    if(idx===null) hint.textContent="Ch∆∞a thi·∫øt l·∫≠p.";
    else if(idx<0) hint.textContent="Ch∆∞a ƒë·∫øn ng√†y b·∫Øt ƒë·∫ßu.";
    else if(idx>=DAYS) hint.textContent="ƒê√£ qua 30 ng√†y.";
    else hint.textContent="H√¥m nay: Ng√†y "+(idx+1);
  }
}

/* ================== LEADERBOARD / PROGRESS ================== */
function buildLeaderboard(){
  lbEl.innerHTML="";
  const rows = members.map(m=>({...m,total:totalOf(m.id),streak:streakOf(m.id)}))
                      .sort((a,b)=> b.total - a.total || b.streak - a.streak);
  rows.forEach((m,idx)=>{
    const r=document.createElement('div'); r.className="row";
    const medal=document.createElement('div'); medal.className="medal";
    if(idx===1) medal.classList.add('silver'); if(idx===2) medal.classList.add('bronze');
    medal.textContent = idx+1;
    const name=document.createElement('div'); name.className="name";
    name.innerHTML = `<span class="avatar ${m.avatarClass}">${m.name[0]}</span><b style="color:${m.color}">${m.name}</b>`;
    const bar=document.createElement('div'); bar.className="bar";
    const span=document.createElement('span'); span.style.width=(m.total/DAYS*100)+"%"; span.style.background=m.color; bar.appendChild(span);
    const cnt=document.createElement('div'); cnt.className="cnt"; cnt.textContent = `${m.total}/${DAYS} ‚Ä¢ üî• ${m.streak}`;
    r.append(medal,name,bar,cnt); lbEl.appendChild(r);
  });
}
function buildProgress(){
  prWrap.innerHTML="";
  members.forEach(m=>{
    const t=totalOf(m.id);
    const idx=todayIndexFor(m.id);
    const box=document.createElement('div'); box.className="row";
    const label=document.createElement('div');
    let nowTxt="Ch∆∞a thi·∫øt l·∫≠p";
    if(idx!==null){
      if(idx<0) nowTxt="Ch∆∞a b·∫Øt ƒë·∫ßu";
      else if(idx>=DAYS) nowTxt="ƒê√£ qua 30 ng√†y";
      else nowTxt=`H√¥m nay: Ng√†y ${idx+1}`;
    }
    label.innerHTML = `<b style="color:${m.color}">${m.name}</b> ‚Ä¢ ${Math.round(t/DAYS*100)}% ‚Ä¢ ${nowTxt}`;
    const bar=document.createElement('div'); bar.className="bar";
    const span=document.createElement('span'); span.style.width=(t/DAYS*100)+"%"; span.style.background=m.color; bar.appendChild(span);
    const nxt=document.createElement('div'); nxt.className="cnt"; nxt.textContent = t>=DAYS? "üéâ 30/30" : `ƒê√£ ‚úÖ: ${t}`;
    box.append(label,bar,nxt); prWrap.appendChild(box);
  });
}

/* ================== TABLE ================== */
let journalTarget = null; // {day, id}
function buildTable(){
  const thead=document.createElement('thead');
  const trh=document.createElement('tr');
  trh.innerHTML = `<th>Ng√†y</th>` + members.map(m=>`<th style="color:${m.color}">${m.name}</th>`).join("");
  thead.appendChild(trh);

  const tbody=document.createElement('tbody');
  for(let d=0; d<DAYS; d++){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><b>Ng√†y ${d+1}</b></td>`;
    members.forEach(m=>{
      const td=document.createElement('td');
      const enabled = isCellEnabled(d, m.id);
      const checked = !!state.days[d][m.id];
      td.className = "daycell " + (checked?"done ":"") + (enabled?"enabled":"lock");
      td.dataset.day=d; td.dataset.id=m.id;
      td.innerHTML = checked ? "‚úÖ" : `<span style="opacity:.35">‚Äî</span>`;

      // n√∫t m·ªü nh·∫≠t k√Ω
      const pin = document.createElement('span'); pin.className="editpin"; pin.textContent="üìù";
      pin.title="Xem/ghi nh·∫≠t k√Ω ng√†y n√†y";
      pin.onclick = (e)=>{ e.stopPropagation(); openJournal(d,m.id); };

      if(enabled){
        td.title = `${m.name} ‚Ä¢ Ng√†y ${d+1} ‚Ä¢ Nh·∫•n ƒë·ªÉ b·∫≠t/t·∫Øt`;
        td.onclick = ()=> doToggle(d, m.id);
      }else{
        td.title = `${m.name} ‚Ä¢ Ng√†y ${d+1}`;
      }
      td.appendChild(pin);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  tableEl.innerHTML=""; tableEl.append(thead,tbody);
}

/* ================== JOURNAL MODAL ================== */
const backdrop=document.getElementById('backdrop');
const modalTitle=document.getElementById('modalTitle');
const inpWeight=document.getElementById('inpWeight');
const inpNote=document.getElementById('inpNote');
const inpImgUrl=document.getElementById('inpImgUrl');
const inpImgFile=document.getElementById('inpImgFile');

function openJournal(day,id){
  journalTarget={day,id};
  modalTitle.textContent = `Nh·∫≠t k√Ω ‚Ä¢ ${members.find(m=>m.id===id).name} ‚Ä¢ Ng√†y ${day+1}`;
  const j = state.journal[day][id] || {w:null,note:"",imgUrl:"",imgData:null};
  inpWeight.value = j.w ?? "";
  inpNote.value = j.note ?? "";
  inpImgUrl.value = j.imgUrl ?? "";
  inpImgFile.value = "";
  backdrop.style.display="flex";
}
function closeModal(){ backdrop.style.display="none"; journalTarget=null; }

function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const rd=new FileReader(); rd.onload=()=>res(rd.result); rd.onerror=rej; rd.readAsDataURL(file);
  });
}
async function saveJournal(){
  if(!journalTarget) return;
  const {day,id} = journalTarget;
  let imgData=null, imgUrl=inpImgUrl.value.trim();
  if(inpImgFile.files && inpImgFile.files[0]){
    try{ imgData = await readFileAsDataURL(inpImgFile.files[0]); }catch{}
  }
  state.journal[day][id] = {
    w: inpWeight.value? Number(inpWeight.value) : null,
    note: inpNote.value.trim(),
    imgUrl: imgUrl || null,
    imgData: imgData || (state.journal[day][id]?.imgData ?? null)
  };
  save(state);
  closeModal();
  toast("ƒê√£ l∆∞u nh·∫≠t k√Ω.");
}

/* ================== CHART ================== */
let chart;
function buildChart(){
  const ctx=document.getElementById('barChart');
  const totals=members.map(m=>totalOf(m.id));
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:members.map(m=>m.name),
      datasets:[{
        label:'S·ªë ng√†y ƒë√£ ‚úÖ',
        data:totals,
        backgroundColor:['#ff8fab','#ffb3c1','#ffd6a5'], /* pastel pink/orange */
        borderColor:['#ff8fab','#ffb3c1','#ffd6a5'],
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:(c)=>`${c.parsed.y}/${DAYS} ng√†y`}}
      },
      scales:{
        y:{beginAtZero:true,suggestedMax:30,ticks:{color:'#6b7280'},grid:{color:'#f3cdd6'}},
        x:{ticks:{color:'#6b7280'},grid:{display:false}}
      }
    }
  });
}

/* ================== CONFETTI + TOAST + DING ================== */
const confettiCanvas=document.getElementById('confetti');
const cctx=confettiCanvas.getContext('2d');
function sizeCanvas(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; }
sizeCanvas(); addEventListener('resize',sizeCanvas);
let particles=[];
function burst(x,y,emoji="üéâ"){
  for(let i=0;i<28;i++){
    particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()*-6)-2,rot:Math.random()*6,life:60,emoji,spin:(Math.random()-0.5)*0.3,size:18+Math.random()*10});
  }
}
(function tick(){
  cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  particles.forEach(p=>{p.life--; p.x+=p.vx; p.vy+=0.18; p.y+=p.vy; p.rot+=p.spin;
    cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot); cctx.font=p.size+"px serif"; cctx.fillText(p.emoji,0,0); cctx.restore();
  });
  particles=particles.filter(p=>p.life>0);
  requestAnimationFrame(tick);
})();

function toast(msg, ms=2200){
  toastEl.textContent=msg; toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), ms);
}
function playDing(){ try{ dingEl.currentTime=0; dingEl.play(); }catch{} }

/* ================== MILESTONES & STREAK WARN ================== */
const QUOTES = [
  "K·ª∑ lu·∫≠t ƒë∆∞a b·∫°n t·ªõi n∆°i ƒë·ªông l·ª±c kh√¥ng th·ªÉ.",
  "M·ªói ng√†y m·ªôt b∆∞·ªõc nh·ªè, 30 ng√†y m·ªôt b∆∞·ªõc ngo·∫∑t.",
  "B·∫°n kh√¥ng c·∫ßn nhanh ‚Äì ch·ªâ c·∫ßn ki√™n tr√¨.",
  "C∆° th·ªÉ l√† nh·∫≠t k√Ω c·ªßa th√≥i quen. H√£y vi·∫øt ƒëi·ªÅu b·∫°n t·ª± h√†o!"
];
function showMilestone(id, total){
  const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
  toast(`üèÖ ${getName(id)} ƒë·∫°t m·ªëc ${total}/30! ${q}`, 4000);
  burst(innerWidth/2, innerHeight/3, "‚ú®");
}
function getName(id){ return members.find(m=>m.id===id).name; }

function checkMilestones(id){
  const t=totalOf(id);
  [7,15,30].forEach(m=>{
    if(t===m && !state.meta.milestoneShown[id][m]){
      state.meta.milestoneShown[id][m]=true; save(state);
      showMilestone(id, m);
    }
  });
}
/* C·∫£nh b√°o streak gi·∫£m n·∫øu h√¥m qua kh√¥ng ‚úÖ (ch·ªâ khi ƒë√£ b·∫Øt ƒë·∫ßu) */
function checkStreakDropOnLoad(){
  members.forEach(m=>{
    const idx=todayIndexFor(m.id);
    if(idx===null || idx<=0 || idx>=DAYS) return;
    const yesterday = idx-1;
    if(!state.days[yesterday][m.id]){ // b·ªè l·ª° h√¥m qua
      toast(`‚ö†Ô∏è ${m.name} b·ªã gi·∫£m streak (b·ªè l·ª° ng√†y ${yesterday+1}).`);
    }
  });
}

/* ================== ACTIONS ================== */
function doToggle(day,id){
  if(!isCellEnabled(day,id)) return;
  state.days[day][id] = !state.days[day][id];
  save(state); refresh();
}
function checkin(id){
  const idx=todayIndexFor(id);
  if(idx===null){ toast("Ch∆∞a ƒë·∫∑t ng√†y b·∫Øt ƒë·∫ßu cho "+getName(id)); return; }
  if(idx<0){ toast("Ch∆∞a ƒë·∫øn ng√†y b·∫Øt ƒë·∫ßu."); return; }
  if(idx>=DAYS){ toast("ƒê√£ k·∫øt th√∫c 30 ng√†y."); return; }
  if(state.days[idx][id]){ toast("H√¥m nay ƒë√£ check-in r·ªìi."); return; }
  state.days[idx][id]=true; save(state);
  playDing();
  burst(innerWidth/2, innerHeight/3, "üéä");
  checkMilestones(id);
  refresh();
}

function resetAll(){
  if(!confirm("Xo√° to√†n b·ªô d·ªØ li·ªáu & ng√†y b·∫Øt ƒë·∫ßu?")) return;
  state = defaultState(); save(state); refresh();
}
function exportData(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='30days-data.json'; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{
    try{ const obj=JSON.parse(rd.result); if(!obj.days||obj.days.length!==DAYS) throw 0; state=obj; save(state); refresh(); }
    catch{ alert("T·ªáp kh√¥ng h·ª£p l·ªá."); }
  };
  rd.readAsText(f); e.target.value="";
});

/* ================== BUILD ================== */
function buildTableAndHighlights(){
  buildTable();
  // highlight ‚Äúh√¥m nay‚Äù m·ªói ng∆∞·ªùi
  members.forEach(m=>{
    const idx=todayIndexFor(m.id);
    if(idx!==null && idx>=0 && idx<DAYS){
      const cell=tableEl.querySelector(`td.daycell[data-day="${idx}"][data-id="${m.id}"]`);
      if(cell) cell.style.boxShadow="0 0 0 2px rgba(255,143,171,.6)";
    }
  });
}
function refresh(){
  buildStartSettings();
  members.forEach(m=>updateStartHints(m.id));
  buildLeaderboard();
  buildProgress();
  buildTableAndHighlights();
  buildChart();
}
refresh();
checkStreakDropOnLoad();
</script>
</body>
</html>
