<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>30 NGÀY BYE BYE MỠ BỤNG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --p1:#ff8fab; --p2:#ffb3c1; --p3:#ffd6a5;
    --bg:#fff7fb; --bg-grad:#fff0f6;
    --text:#2b2b2b; --muted:#6b7280;
    --card:#ffffff; --border:#f4dbe3;
    --col-huong:#ff8fab; --col-thuy:#a5b4fc; --col-lien:#9adbb3;
  }
  body{margin:0;font-family:Inter,system-ui;background:linear-gradient(180deg,var(--bg-grad) 0%, #fff 40%);}
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .hero{border:1px solid var(--border);border-radius:18px;padding:22px;
        background:linear-gradient(135deg,#fff0f6 0%,#fff 45%,#fff5f0 100%);
        box-shadow:0 12px 28px rgba(255,168,186,.20);}
  .hero h1{margin:0;font-size:30px}
  .subtitle{margin-top:6px;color:var(--muted);font-size:16px}
  .toast{position:fixed;right:16px;bottom:16px;background:#fff;
        border:1px solid var(--border);padding:12px 14px;border-radius:12px;
        box-shadow:0 12px 30px rgba(0,0,0,.12);display:none;font-weight:600}
  .toast.show{display:block;animation:fade .18s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  canvas#confetti{position:fixed;inset:0;pointer-events:none}
  table{border-collapse:collapse;margin-top:16px;width:100%}
  th,td{padding:8px 12px;border:1px solid #eee;text-align:center}
  td.daycell.done{background:#ffeef3}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="hero">
    <h1>30 NGÀY BYE BYE MỠ BỤNG</h1>
    <div class="subtitle">Đừng chờ động lực mới bắt đầu. Hãy bắt đầu để tạo ra động lực. 🌸</div>
  </div>

  <!-- Chọn ngày bắt đầu -->
  <div style="margin-top:20px">
    <label>Thành viên:</label>
    <select id="whoSelect">
      <option value="Huong">Hương</option>
      <option value="Thuy">Thùy</option>
      <option value="Lien">Liên</option>
    </select>
    <label>Ngày bắt đầu:</label>
    <input type="date" id="startDateInput"/>
    <button onclick="saveStart()">Lưu ngày bắt đầu</button>
    <div id="startSummary" style="margin-top:8px"></div>
  </div>

  <!-- Leaderboard -->
  <div style="margin-top:20px" id="leaderboard"></div>

  <!-- Biểu đồ -->
  <div style="margin:20px 0">
    <canvas id="barChart" height="180"></canvas>
  </div>

  <!-- Bảng 30 ngày -->
  <div style="margin-top:20px">
    <table id="daysTable"></table>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ================== FIREBASE CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyB9MISUTOozdHB5wQvQpNGARrCVM4qRIF0",
  authDomain: "ngay-bye-bye-mo-bung.firebaseapp.com",
  projectId: "ngay-bye-bye-mo-bung",
  storageBucket: "ngay-bye-bye-mo-bung.appspot.com",
  messagingSenderId: "568512660319",
  appId: "1:568512660319:web:28913b61e0a0b67598ecea",
  measurementId: "G-4NLDXQKW5Q"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ROOM_ID = "main"; 
const docRef = () => db.collection("rooms").doc(ROOM_ID);

/* ================== STATE ================== */
const DAYS=30;
const members=[
  {id:"Huong",name:"Hương",color:"var(--col-huong)"},
  {id:"Thuy",name:"Thùy",color:"var(--col-thuy)"},
  {id:"Lien",name:"Liên",color:"var(--col-lien)"}
];
function defaultState(){
  return {
    days:Array.from({length:DAYS},()=>({Huong:false,Thuy:false,Lien:false})),
    startDate:{Huong:null,Thuy:null,Lien:null}
  };
}
let state=defaultState();

/* ================== TOOLS ================== */
const toastEl=document.getElementById('toast');
function toast(msg,ms=2000){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),ms);}
function playDing(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),g=ctx.createGain();o.type="sine";o.frequency.value=880;g.gain.setValueAtTime(0.0001, ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+0.2);}catch{}}
function burst(x,y,emoji="🌸"){for(let i=0;i<25;i++){particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()*-6)-2,rot:Math.random()*6,life:60,emoji,spin:(Math.random()-0.5)*0.3,size:18+Math.random()*10});}}
const confettiCanvas=document.getElementById('confetti');const cctx=confettiCanvas.getContext('2d');
function sizeCanvas(){confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight;}sizeCanvas();addEventListener('resize',sizeCanvas);
let particles=[];(function tick(){cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);particles.forEach(p=>{p.life--;p.x+=p.vx;p.vy+=0.18;p.y+=p.vy;p.rot+=p.spin;cctx.save();cctx.translate(p.x,p.y);cctx.rotate(p.rot);cctx.font=p.size+"px serif";cctx.fillText(p.emoji,0,0);cctx.restore();});particles=particles.filter(p=>p.life>0);requestAnimationFrame(tick);})();
const MOTIVATION=["Cố lên!!! 💪","Tuyệt vời, bạn làm được rồi! 🌟","Giữ vững phong độ nhé! 🔥","Mỗi ngày một bước nhỏ, bạn đang tiến bộ! 🚀","Bạn mạnh mẽ hơn bạn nghĩ! 💖"];
function randomMsg(){return MOTIVATION[Math.floor(Math.random()*MOTIVATION.length)];}

/* ================== FIRESTORE ================== */
function save(){docRef().set(state,{merge:true});}
function subscribeRealtime(){docRef().onSnapshot(snap=>{if(snap.exists){state=Object.assign(defaultState(),snap.data());render();}else{docRef().set(state);}});}

/* ================== APP LOGIC ================== */
function saveStart(){
  const who=document.getElementById('whoSelect').value;
  const date=document.getElementById('startDateInput').value;
  if(date){ state.startDate[who]=date; save(); render(); }
}

function getStreak(id){
  let streak=0,maxStreak=0;
  for(let d=0;d<DAYS;d++){
    if(state.days[d][id]){streak++; if(streak>maxStreak)maxStreak=streak;}
    else{streak=0;}
  }
  return maxStreak;
}

function doToggle(day,id){
  // Không cho tick trước ngày bắt đầu
  const start=state.startDate[id];
  if(start){
    const startIdx=Math.floor((new Date()-new Date(start))/(1000*60*60*24));
    if(day>startIdx){ toast("Chưa tới ngày này!"); return; }
  }
  state.days[day][id]=!state.days[day][id];
  save();burst(innerWidth/2, innerHeight/3,"🌸");playDing();
  const total=state.days.reduce((a,d)=>a+(d[id]?1:0),0);
  if([7,15,30].includes(total)){ toast(`🎉 ${members.find(m=>m.id==id).name} đạt mốc ${total} ngày!`); burst(innerWidth/2, innerHeight/2,"🎉"); }
  else{ toast(randomMsg()); }
  render();
}

function buildLeaderboard(){
  let html="<h2>🏆 Leaderboard</h2>";
  members.forEach(m=>{
    const total=state.days.reduce((a,d)=>a+(d[m.id]?1:0),0);
    const streak=getStreak(m.id);
    html+=`<div><b style="color:${m.color}">${m.name}</b>: ${total}/${DAYS} ngày • 🔥 ${streak} streak</div>`;
  });
  document.getElementById('leaderboard').innerHTML=html;
}

let chart;
function buildChart(){
  const ctx=document.getElementById('barChart');
  const totals=members.map(m=>state.days.reduce((a,d)=>a+(d[m.id]?1:0),0));
  if(chart)chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels:members.map(m=>m.name),datasets:[{data:totals,backgroundColor:['#ff8fab','#a5b4fc','#9adbb3']}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,suggestedMax:30}}}});
}

const tableEl=document.getElementById('daysTable');
function render(){
  // summary start dates
  let sumHtml="";
  members.forEach(m=>{
    if(state.startDate[m.id]) sumHtml+=`${m.name}: bắt đầu ${state.startDate[m.id]}<br>`;
  });
  document.getElementById('startSummary').innerHTML=sumHtml;

  buildLeaderboard();
  buildChart();
  const thead=document.createElement('thead');
  let headerRow=document.createElement('tr');
  headerRow.innerHTML="<th>Ngày</th>";
  members.forEach(m=>{headerRow.innerHTML+=`<th style="color:${m.color}">${m.name}</th>`;});
  thead.appendChild(headerRow);

  const tbody=document.createElement('tbody');
  for(let d=0;d<DAYS;d++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><b>${d+1}</b></td>`;
    members.forEach(m=>{
      const td=document.createElement('td');
      td.textContent=state.days[d][m.id]?"✅":"—";
      td.className="daycell"+(state.days[d][m.id]?" done":"");
      td.onclick=()=>doToggle(d,m.id);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  tableEl.innerHTML="";
  tableEl.appendChild(thead);
  tableEl.appendChild(tbody);
}
subscribeRealtime();
</script>
</body>
</html>
